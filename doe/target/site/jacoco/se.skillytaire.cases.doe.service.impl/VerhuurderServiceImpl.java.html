<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VerhuurderServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DOE</a> &gt; <a href="index.source.html" class="el_package">se.skillytaire.cases.doe.service.impl</a> &gt; <span class="el_source">VerhuurderServiceImpl.java</span></div><h1>VerhuurderServiceImpl.java</h1><pre class="source lang-java linenums">package se.skillytaire.cases.doe.service.impl;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.function.Predicate;
import java.util.logging.Logger;

import se.skillytaire.cases.doe.common.TochtType;
import se.skillytaire.cases.doe.common.VoertuigType;
import se.skillytaire.cases.doe.domain.Boot;
import se.skillytaire.cases.doe.domain.BootBestaatNietException;
import se.skillytaire.cases.doe.domain.ElektrischeBoot;
import se.skillytaire.cases.doe.domain.GeenBootVrijException;
import se.skillytaire.cases.doe.domain.Klant;
import se.skillytaire.cases.doe.domain.Klantenbak;
import se.skillytaire.cases.doe.domain.RoeiBoot;
import se.skillytaire.cases.doe.domain.Tocht;
import se.skillytaire.cases.doe.domain.Tochtenbak;
import se.skillytaire.cases.doe.domain.Vloot;
import se.skillytaire.cases.doe.service.BootInformatie;
import se.skillytaire.cases.doe.service.KlantInformatie;
import se.skillytaire.cases.doe.service.StartTochtInformatie;
import se.skillytaire.cases.doe.service.TochtEinde;
import se.skillytaire.cases.doe.service.VerhuurderService;
import se.skillytaire.cases.doe.service.toa.BootTransferableObjectAssembler;
import se.skillytaire.cases.doe.service.toa.KlantTransferableObjectAssembler;

public class VerhuurderServiceImpl implements VerhuurderService, Serializable {

	private static final long serialVersionUID = 1L;
	private static final String SERFILE = &quot;verhuurder.ser&quot;;
<span class="nc" id="L44">	private static final String USER_HOME = System.getProperty(&quot;user.home&quot;);</span>
<span class="nc" id="L45">	private static final Path SER_FILE_PATH = Paths.get(VerhuurderServiceImpl.USER_HOME, VerhuurderServiceImpl.SERFILE);</span>
<span class="nc" id="L46">	private static final Logger log = Logger.getLogger(VerhuurderServiceImpl.class.getName());</span>
	private static final VerhuurderServiceImpl instance;

	static {

<span class="nc bnc" id="L51" title="All 2 branches missed.">		if (Files.exists(VerhuurderServiceImpl.SER_FILE_PATH)) {</span>
<span class="nc" id="L52">			VerhuurderServiceImpl.log.info(&quot;Loading the state of the verhuurder&quot;);</span>
<span class="nc" id="L53">			try (ObjectInputStream ois = new ObjectInputStream(new BufferedInputStream(</span>
<span class="nc" id="L54">					Files.newInputStream(VerhuurderServiceImpl.SER_FILE_PATH, StandardOpenOption.READ)))) {</span>
<span class="nc" id="L55">				instance = (VerhuurderServiceImpl) ois.readObject();</span>
<span class="nc" id="L56">				VerhuurderServiceImpl.log.info(&quot;The state of the verhuurder is loaded&quot;);</span>
<span class="nc bnc" id="L57" title="All 8 branches missed.">			} catch (final IOException e) {</span>
<span class="nc" id="L58">				throw new IllegalStateException(&quot;Error reading the state of the verhuurder from path &quot;</span>
<span class="nc" id="L59">						+ VerhuurderServiceImpl.SER_FILE_PATH.toAbsolutePath(), e);</span>
<span class="nc" id="L60">			} catch (final ClassNotFoundException e) {</span>
<span class="nc" id="L61">				throw new IllegalStateException(&quot;Error reading the state of the verhuurder, classpath problem&quot;, e);</span>
<span class="nc" id="L62">			}</span>
		} else {
<span class="nc" id="L64">			VerhuurderServiceImpl.log.info(&quot;Loading initial state for the verhuurder&quot;);</span>
<span class="nc" id="L65">			instance = new VerhuurderServiceImpl();</span>
		}
<span class="nc" id="L67">	}</span>

	private final Tochtenbak eenTochtenbak;
	private final Vloot eenVloot;
	private final Klantenbak eenKlantenbak;

<span class="nc" id="L73">	private VerhuurderServiceImpl() {</span>
<span class="nc" id="L74">		eenTochtenbak = new Tochtenbak();</span>
<span class="nc" id="L75">		eenVloot = new Vloot();</span>
<span class="nc" id="L76">		eenKlantenbak = new Klantenbak();</span>

<span class="nc" id="L78">		final String[] namenRoeiboten = { &quot;Patrick de Verschrikkelijke&quot;, &quot;blaadje&quot;, &quot;bloemetje&quot;, &quot;veertje&quot;, &quot;clara&quot; };</span>
<span class="nc" id="L79">		final String[] namenElektrischeboten = { &quot;De Grote Hugo&quot;, &quot;Petra de Verkenner&quot;, &quot;vliegende hollander&quot;,</span>
				&quot;vallende fransman&quot;, &quot;spaanse furie&quot; };

<span class="nc bnc" id="L82" title="All 2 branches missed.">		for (int i = 0; i &lt; namenRoeiboten.length; i++) {</span>
<span class="nc" id="L83">			final RoeiBoot eenBoot = new RoeiBoot(1 + i, namenRoeiboten[i], 4, 25);</span>
<span class="nc" id="L84">			eenVloot.add(eenBoot);</span>
<span class="nc" id="L85">			final ElektrischeBoot eenBoot2 = new ElektrischeBoot(100 + i, namenElektrischeboten[i], 6, 25);</span>
<span class="nc" id="L86">			eenVloot.add(eenBoot2);</span>
		}
<span class="nc" id="L88">	}</span>

	public static VerhuurderServiceImpl getInstance() {
<span class="nc" id="L91">		return VerhuurderServiceImpl.instance;</span>
	}

	public static VerhuurderServiceImpl getInstance(boolean clear) {
<span class="nc bnc" id="L95" title="All 2 branches missed.">		if (clear) {</span>
<span class="nc" id="L96">			VerhuurderServiceImpl.instance.eenVloot.clear();</span>
<span class="nc" id="L97">			VerhuurderServiceImpl.instance.eenTochtenbak.clear();</span>
<span class="nc" id="L98">			VerhuurderServiceImpl.instance.persist();</span>
		}
<span class="nc" id="L100">		return VerhuurderServiceImpl.instance;</span>
	}

	@Override
	public TochtEinde beeindigTocht(final int bootNummer) throws BootBestaatNietException {
		Duration duur;
<span class="nc" id="L106">		final Boot eenBoot = eenVloot.getBoot(bootNummer);</span>
<span class="nc" id="L107">		duur = eenBoot.beeindigTocht();</span>
<span class="nc" id="L108">		final boolean inspectie = eenBoot.isInspectieNodig();</span>
<span class="nc" id="L109">		final TochtEinde einde = new TochtEinde(duur, inspectie);</span>
<span class="nc" id="L110">		persist();</span>
<span class="nc" id="L111">		return einde;</span>
	}

	@Override
	public int geefAantalBeeindigdeTochten() {
		int aantal;
<span class="nc" id="L117">		aantal = eenTochtenbak.geefAantalBeeindigdeTochten();</span>
<span class="nc" id="L118">		return aantal;</span>
	}

	/*
	 * (non-Javadoc)
	 *
	 * @see se.skillytaire.cases.doe.service.VerhuurderService#geefGemiddeldeDuur()
	 */
	@Override
	public Duration geefGemiddeldeDuur() {
		Duration duur;
<span class="nc" id="L129">		duur = eenTochtenbak.geefGemiddeldeDuur();</span>
<span class="nc" id="L130">		return duur;</span>
	}

	@Override
	public int startTocht(final StartTochtInformatie info) {
		int bootnummer;
		Boot eenBoot;
<span class="nc" id="L137">		final TochtType tochtType = info.getTochtType();</span>
<span class="nc" id="L138">		final Duration verwachteDuur = info.getVerwachteDuur();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (info.isByNumber()) {</span>
<span class="nc" id="L140">			bootnummer = info.getBootNummer();</span>
<span class="nc" id="L141">			final LocalDateTime beginTijd = LocalDateTime.now();</span>
<span class="nc" id="L142">			Predicate&lt;Boot&gt; p = (b) -&gt; {</span>
<span class="nc bnc" id="L143" title="All 6 branches missed.">				return b.getNummer() == bootnummer &amp;&amp; b.isBeschikbaar() &amp;&amp; b.isVrij(beginTijd, verwachteDuur);</span>
			};
<span class="nc" id="L145">			eenBoot = eenVloot.find(p);</span>
<span class="nc" id="L146">		} else {</span>
<span class="nc" id="L147">			final LocalDateTime beginTijd = LocalDateTime.now();</span>
<span class="nc" id="L148">			final VoertuigType bootType = info.getBootType();</span>
<span class="nc" id="L149">			final Predicate&lt;Boot&gt; criteria = (boot) -&gt; {</span>
<span class="nc bnc" id="L150" title="All 6 branches missed.">				return boot.getType().equals(bootType) &amp;&amp; boot.isVrij(beginTijd, verwachteDuur) &amp;&amp; boot.isBeschikbaar();</span>
			};
<span class="nc" id="L152">			eenBoot = eenVloot.geefVrijeBoot(criteria);</span>
<span class="nc" id="L153">			bootnummer = eenBoot.getNummer();</span>
		}

<span class="nc" id="L156">		final Tocht nieuweTocht = Tocht.create(eenBoot.getType(), tochtType, verwachteDuur);</span>
<span class="nc" id="L157">		eenBoot.startTocht(nieuweTocht);</span>
<span class="nc" id="L158">		eenTochtenbak.bewaar(nieuweTocht);</span>
<span class="nc" id="L159">		persist();</span>
<span class="nc" id="L160">		return bootnummer;</span>
	}

	@Override
	public void uitvoerenInspectie(final int nummer) throws BootBestaatNietException {
<span class="nc" id="L165">		final Boot eenBoot = eenVloot.getBoot(nummer);</span>
<span class="nc" id="L166">		eenBoot.uitvoerenInspectie();</span>
<span class="nc" id="L167">		persist();</span>
<span class="nc" id="L168">	}</span>

	@Override
	public boolean eindeDag() {
<span class="nc" id="L172">		return eenTochtenbak.zijnAlleTochtenBeindigd();</span>
	}

	@Override
	public BootInformatie getBootInformatie(final int bootnr) {
<span class="nc" id="L177">		final Boot eenBoot = eenVloot.getBoot(bootnr);</span>
<span class="nc" id="L178">		final BootInformatie to = BootTransferableObjectAssembler.getInstance().assemble(eenBoot);</span>
<span class="nc" id="L179">		return to;</span>
	}

	@Override
	public KlantInformatie getKlantInformatie(final int klantNummer) {
<span class="nc" id="L184">		final Klant eenKlant = eenKlantenbak.geefKlant(klantNummer);		</span>
<span class="nc" id="L185">		return KlantTransferableObjectAssembler.getInstance().assemble(eenKlant);</span>
	}

	private void persist() {

<span class="nc" id="L190">		VerhuurderServiceImpl.log.info(&quot;Saving the state of the verhuurder&quot;);</span>
<span class="nc" id="L191">		try (ObjectOutputStream oos = new ObjectOutputStream(</span>
<span class="nc" id="L192">				new BufferedOutputStream(Files.newOutputStream(VerhuurderServiceImpl.SER_FILE_PATH,</span>
						StandardOpenOption.CREATE, StandardOpenOption.TRUNCATE_EXISTING)))) {
<span class="nc" id="L194">			oos.writeObject(this);</span>
<span class="nc" id="L195">			VerhuurderServiceImpl.log.info(&quot;The state of the verhuurder is saved&quot;);</span>
<span class="nc bnc" id="L196" title="All 8 branches missed.">		} catch (final IOException e) {</span>
<span class="nc" id="L197">			throw new IllegalStateException(&quot;Error writing the state of the verhuurder from path &quot;</span>
<span class="nc" id="L198">					+ VerhuurderServiceImpl.SER_FILE_PATH.toAbsolutePath(), e);</span>
<span class="nc" id="L199">		}</span>

<span class="nc" id="L201">	}</span>

	@Override
	public int registrerenKlant(KlantInformatie klantInfo) {
<span class="nc" id="L205">		Klant klant=KlantTransferableObjectAssembler.getInstance().assemble(klantInfo);</span>
<span class="nc" id="L206">		eenKlantenbak.bewaar(klant);</span>
<span class="nc" id="L207">		persist();</span>
<span class="nc" id="L208">		return klant.getKlantNummer();</span>
	}

	@Override
	public ArrayList&lt;BootInformatie&gt; geefVrijeBoten(final LocalDateTime datumtijd, final Duration duur) {
<span class="nc" id="L213">		final List&lt;Boot&gt; vrijeboten = eenVloot.findBoten(p -&gt; p.isVrij(datumtijd, duur));</span>
<span class="nc" id="L214">		final ArrayList&lt;BootInformatie&gt; vrijebotentransfer = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">		for (final Boot eenBoot : vrijeboten) {</span>
<span class="nc" id="L216">			final BootInformatie transferobject = BootTransferableObjectAssembler.getInstance().assemble(eenBoot);</span>
<span class="nc" id="L217">			vrijebotentransfer.add(transferobject);</span>
<span class="nc" id="L218">		}</span>

<span class="nc" id="L220">		return vrijebotentransfer;</span>
	}

	@Override
	public boolean reserveren(final String typeTocht, final String typeBoot, final LocalDateTime datumtijd,
			final Duration duur) throws GeenBootVrijException {
<span class="nc" id="L226">		Boot eenBoot = null;</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (typeBoot.equals(&quot;RoeiBoot&quot;)) {</span>
<span class="nc" id="L228">			eenBoot = eenVloot.geefVrijeRoeiBoot(datumtijd, duur);</span>
<span class="nc bnc" id="L229" title="All 4 branches missed.">			if (eenBoot != null &amp;&amp; typeTocht.equals(&quot;MeerTocht&quot;)) {</span>
<span class="nc" id="L230">				final Tocht eenTocht = eenBoot.reserveerMeerTocht(datumtijd, duur);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">				return eenTocht != null;</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">			} else if (eenBoot != null &amp;&amp; typeTocht.equals(&quot;RivierTocht&quot;)) {</span>
<span class="nc" id="L233">				final Tocht eenTocht = eenBoot.reserveerRivierTocht(datumtijd, duur);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				return eenTocht != null;</span>
			}
<span class="nc bnc" id="L236" title="All 2 branches missed.">		} else if (typeBoot.equals(&quot;Elektrisch&quot;)) {</span>
<span class="nc" id="L237">			eenBoot = eenVloot.geefVrijeElektrischeBoot(datumtijd, duur);</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">			if (eenBoot != null &amp;&amp; typeTocht.equals(&quot;MeerTocht&quot;)) {</span>
<span class="nc" id="L239">				final Tocht eenTocht = eenBoot.reserveerMeerTocht(datumtijd, duur);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				return eenTocht != null;</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">			} else if (eenBoot != null &amp;&amp; typeTocht.equals(&quot;RivierTocht&quot;)) {</span>
<span class="nc" id="L242">				final Tocht eenTocht = eenBoot.reserveerRivierTocht(datumtijd, duur);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">				return eenTocht != null;</span>
			}
		}
<span class="nc bnc" id="L246" title="All 2 branches missed.">		return eenBoot != null;</span>
	}

	

	@Override
	public boolean createBoot(BootInformatie bootinfo) {
<span class="nc" id="L253">		BootTransferableObjectAssembler btoa = BootTransferableObjectAssembler.getInstance();</span>
<span class="nc" id="L254">		Boot newBoot = btoa.assemble(bootinfo);</span>
<span class="nc" id="L255">		return eenVloot.add(newBoot);</span>
	}

	@Override
	public int getAantalBoten() {

<span class="nc" id="L261">		return this.eenVloot.size();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>